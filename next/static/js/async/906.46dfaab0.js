"use strict";(self.webpackChunk_kaya_web=self.webpackChunk_kaya_web||[]).push([["906"],{161(e,i,t){t.d(i,{TauriEngine:()=>a});var n=t(990),o=t(255);function r(){if(!function(){try{if("undefined"==typeof window||null===window)return!1;let e=window;return"__TAURI_INTERNALS__"in e||"__TAURI__"in e}catch{return!1}}())return null;try{var e,i,t;let n=window;if(null==(i=n.__TAURI__)||null==(e=i.core)?void 0:e.invoke)return n.__TAURI__.core.invoke;if(null==(t=n.__TAURI_INTERNALS__)?void 0:t.invoke)return n.__TAURI_INTERNALS__.invoke;return null}catch{return null}}class a extends o.N{reportProgress(e,i,t){var n;null==(n=this.onProgress)||n.call(this,{stage:e,progress:i,message:t})}debugLog(e,i){this.debugEnabled&&(i?console.log("[TauriEngine][debug]",e,i):console.log("[TauriEngine][debug]",e))}async initialize(){if(!this.initialized){if(!this.invoke)throw Error("TauriEngine can only be used in a Tauri environment");try{let e=performance.now();if(await this.invoke("onnx_set_provider_preference",{preference:this.executionProvider}),this.modelId){this.reportProgress("checking-cache",0,"Checking for cached model...");let i=await this.invoke("onnx_get_cached_model",{modelId:this.modelId});if(i){this.reportProgress("initializing",50,"Loading cached model..."),await this.invoke("onnx_initialize_from_path",{modelPath:i}),this.reportProgress("initializing",100,"Ready");let t=performance.now()-e,n=await this.getProviderInfo(),o=(null==n?void 0:n.isGpu)?"NATIVE/GPU":"NATIVE/CPU",r=(null==n?void 0:n.name)?` (${n.name})`:"",a=t>=1e3?`${(t/1e3).toFixed(1)}s`:`${t.toFixed(0)}ms`;console.log(`[AI] Model loaded: ${o}${r} in ${a}`),this.initialized=!0;return}}if(this.modelBuffer){let e=(this.modelBuffer.byteLength/1024/1024).toFixed(1),i=Math.ceil(this.modelBuffer.byteLength/1048576);this.reportProgress("uploading",0,`Preparing to upload ${e}MB model...`);let t=performance.now();await this.invoke("onnx_start_upload");let n=new Uint8Array(this.modelBuffer);for(let t=0;t<i;t++){let o=1048576*t,r=Math.min(o+1048576,n.length),a=n.subarray(o,r),l=function(e){let i="";for(let t=0;t<e.length;t+=32768){let n=Math.min(t+32768,e.length),o=e.subarray(t,n);for(let e=0;e<o.length;e++)i+=String.fromCharCode(o[e])}return btoa(i)}(a);await this.invoke("onnx_upload_chunk",{chunkBase64:l}),await new Promise(e=>setTimeout(e,0));let s=Math.round((t+1)/i*100),h=((t+1)*1048576/1024/1024).toFixed(0);this.reportProgress("uploading",s,`Uploading model: ${h}/${e}MB (${s}%)`)}let o=performance.now()-t;this.debugLog("Upload complete",{uploadTimeMs:o,totalChunks:i}),this.reportProgress("initializing",100,"Initializing ONNX engine...");let r=performance.now();await this.invoke("onnx_finish_upload",{modelId:this.modelId??null});let a=performance.now()-r;this.debugLog("Engine initialized",{engineTimeMs:a}),this.reportProgress("initializing",100,"Ready")}else if(this.modelPath)this.reportProgress("initializing",50,"Loading model from file..."),this.debugLog("Initializing from path",{path:this.modelPath}),await this.invoke("onnx_initialize_from_path",{modelPath:this.modelPath}),this.reportProgress("initializing",100,"Ready");else throw Error("No model provided (need modelBuffer or modelPath)");let i=performance.now()-e,t=await this.getProviderInfo(),n=(null==t?void 0:t.isGpu)?"NATIVE/GPU":"NATIVE/CPU",o=(null==t?void 0:t.name)?` (${t.name})`:"",r=i>=1e3?`${(i/1e3).toFixed(1)}s`:`${i.toFixed(0)}ms`;console.log(`[AI] Model loaded: ${n}${o} in ${r}`),this.initialized=!0}catch(e){throw console.error("[TauriEngine] Failed to initialize:",e),e}}}getCapabilities(){return{name:"KataGo (Native ONNX)",version:"1.0.0",supportedBoardSizes:[],supportsParallel:!0,providesPV:!1,providesWinRate:!0,providesScoreLead:!0,metadata:{backend:"native",runtime:"ort"}}}async analyzePosition(e,i){if(!this.invoke)throw Error("TauriEngine can only be used in a Tauri environment");let t=performance.now(),n=e.map(e=>e.map(e=>e)),o={komi:i.komi??7.5,nextToPlay:i.nextToPlay,history:this.convertHistory(i.history)};this.debugLog("Analyzing position",{boardSize:e.length,nextToPlay:o.nextToPlay,historyLength:o.history.length});let r=performance.now(),a=await this.invoke("onnx_analyze",{signMap:n,options:o}),l=performance.now()-r,s=performance.now()-t;return this.debugLog("Analysis complete",{totalTimeMs:s,inferenceTimeMs:l}),a}async analyzeBatch(e){if(this.initialized||await this.initialize(),0===e.length)return[];if(!this.invoke)throw Error("TauriEngine can only be used in a Tauri environment");let i=performance.now(),t=Array(e.length).fill(null),n=[],o=this.config.enableCache;for(let i=0;i<e.length;i++){let{signMap:r,options:a={}}=e[i];if(o){let e=this.getCacheKey(r,a),n=this.cache.get(e);if(n){t[i]=n;continue}}n.push({index:i,input:{signMap:r.map(e=>e.map(e=>e)),options:{komi:a.komi??7.5,nextToPlay:a.nextToPlay,history:this.convertHistory(a.history)}}})}if(0===n.length)return this.debugLog("Batch resolved from cache",{count:e.length}),t;this.debugLog("Running batch inference",{total:e.length,uncached:n.length});let r=performance.now(),a=n.map(e=>e.input),l=await this.invoke("onnx_analyze_batch",{inputs:a}),s=performance.now()-r;for(let i=0;i<n.length;i++){let{index:r,input:a}=n[i],s=l[i];if(t[r]=s,o){let{signMap:i,options:t={}}=e[r],n=this.getCacheKey(i,t);if(this.cache.set(n,s),this.cache.size>(this.config.maxCacheSize??1e3)){let e=this.cache.keys().next().value;e&&this.cache.delete(e)}}}let h=performance.now()-i,d=h/n.length;return this.debugLog("Batch analysis complete",{positions:n.length,totalTimeMs:h,msPerPos:d,inferenceTimeMs:s}),t}async dispose(){if(this.invoke)try{await this.invoke("onnx_dispose")}catch(e){console.warn("[TauriEngine] Failed to dispose:",e)}await super.dispose()}convertHistory(e){return e?e.map(e=>({color:e.color,x:e.x,y:e.y})):[]}async getProviderInfo(){if(!this.invoke)return null;try{return await this.invoke("onnx_get_provider_info")}catch{return null}}static async getAvailableProviders(){let e=r();if(!e)return[];try{return await e("onnx_get_available_providers")}catch{return[]}}constructor(e={}){super(e),(0,n._)(this,"debugEnabled",!1),(0,n._)(this,"modelBuffer",void 0),(0,n._)(this,"modelPath",void 0),(0,n._)(this,"modelId",void 0),(0,n._)(this,"invoke",null),(0,n._)(this,"onProgress",void 0),(0,n._)(this,"executionProvider",void 0),this.debugEnabled=!!e.debug,this.modelBuffer=e.modelBuffer,this.modelPath=e.modelPath,this.modelId=e.modelId,this.onProgress=e.onProgress,this.executionProvider=e.executionProvider??"auto",this.invoke=r()}}}}]);
//# sourceMappingURL=906.46dfaab0.js.map